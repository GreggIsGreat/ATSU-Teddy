from .models import UserProfile, AnonymousUploadTracker


class UploadTracker:

    @staticmethod
    def get_client_ip(request):
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            return x_forwarded_for.split(',')[0].strip()
        return request.META.get('REMOTE_ADDR')

    @staticmethod
    def get_tracker(request):
        if request.user.is_authenticated:
            profile, _ = UserProfile.objects.get_or_create(user=request.user)
            return profile

        if not request.session.session_key:
            request.session.create()

        session_key = request.session.session_key
        ip_address = UploadTracker.get_client_ip(request)

        # Check by session first, then by IP
        tracker = AnonymousUploadTracker.objects.filter(session_key=session_key).first()

        if not tracker:
            tracker = AnonymousUploadTracker.objects.filter(ip_address=ip_address).first()
            if tracker:
                tracker.session_key = session_key
                tracker.save()
            else:
                tracker = AnonymousUploadTracker.objects.create(
                    session_key=session_key,
                    ip_address=ip_address
                )

        return tracker

    @staticmethod
    def can_upload(request):
        return UploadTracker.get_tracker(request).can_upload()

    @staticmethod
    def get_remaining(request):
        return UploadTracker.get_tracker(request).uploads_remaining

    @staticmethod
    def use_upload(request):
        return UploadTracker.get_tracker(request).use_upload()